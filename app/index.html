<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ prompt-mask</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Anybody:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0e0e10;
            --surface: #18181b;
            --surface-hover: #1e1e22;
            --border: #2a2a2f;
            --text: #e4e4e7;
            --text-muted: #71717a;
            --accent: #f59e0b;
            --accent-dim: #b45309;
            --anon: #f59e0b;
            --block: #ef4444;
            --random: #8b5cf6;
            --success: #22c55e;
            --radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Mono', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ‚îÄ‚îÄ Privacy banner ‚îÄ‚îÄ */
        .privacy-banner {
            background: linear-gradient(90deg, rgba(245,158,11,0.06), rgba(139,92,246,0.06));
            border-bottom: 1px solid var(--border);
            padding: 6px 20px;
            display: flex; align-items: center; justify-content: center;
            gap: 8px; font-size: 11px; color: var(--text-muted);
        }
        .privacy-banner .dot {
            width: 6px; height: 6px; background: var(--success);
            border-radius: 50%; animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        header {
            padding: 24px 40px 0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-left h1 {
            font-family: 'Anybody', sans-serif;
            font-weight: 800; font-size: 28px; letter-spacing: -1px;
        }
        .header-left .tagline {
            color: var(--text-muted); font-size: 12px; margin-top: 4px;
        }
        .header-right { display: flex; gap: 8px; align-items: center; }

        /* ‚îÄ‚îÄ Project selector ‚îÄ‚îÄ */
        .project-selector {
            display: flex; align-items: center; gap: 8px;
        }
        .project-selector label {
            font-size: 11px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .project-selector select {
            font-family: 'DM Mono', monospace;
            font-size: 12px; padding: 5px 10px;
            background: var(--surface); color: var(--text);
            border: 1px solid var(--border); border-radius: var(--radius);
            cursor: pointer; outline: none;
        }
        .project-selector select:focus { border-color: var(--accent-dim); }

        /* ‚îÄ‚îÄ Mode toggle ‚îÄ‚îÄ */
        .mode-toggle {
            display: flex; border: 1px solid var(--border); border-radius: var(--radius);
            overflow: hidden; margin: 16px 40px 0;
        }
        .mode-toggle button {
            flex: 1; border: none; border-radius: 0;
            padding: 8px 20px; font-size: 12px;
            font-family: 'Anybody', sans-serif; font-weight: 600;
            letter-spacing: 0.5px; transition: all 0.15s;
            background: transparent; color: var(--text-muted);
        }
        .mode-toggle button.active {
            background: var(--accent); color: var(--bg);
        }
        .mode-toggle button:not(.active):hover {
            background: var(--surface-hover);
        }

        /* ‚îÄ‚îÄ Workspace ‚îÄ‚îÄ */
        .workspace {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr;
            padding: 16px 40px; gap: 0; min-height: 0;
        }
        .panel { display: flex; flex-direction: column; min-height: 280px; }
        .panel:first-child { padding-right: 16px; border-right: 1px solid var(--border); }
        .panel:last-child { padding-left: 16px; }
        .panel-header {
            display: flex; align-items: center;
            justify-content: space-between; margin-bottom: 8px;
        }
        .panel-label {
            font-family: 'Anybody', sans-serif; font-weight: 600;
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--text-muted);
        }
        .panel-hint {
            font-size: 10px; color: var(--text-muted);
            font-style: italic; margin-bottom: 6px;
        }

        textarea {
            flex: 1; background: var(--surface);
            border: 1px solid var(--border); border-radius: var(--radius);
            color: var(--text); font-family: 'DM Mono', monospace;
            font-size: 13px; line-height: 1.7; padding: 16px;
            resize: none; outline: none; transition: border-color 0.2s;
        }
        textarea:focus { border-color: var(--accent-dim); }
        textarea::placeholder { color: var(--text-muted); font-style: italic; }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        button {
            font-family: 'DM Mono', monospace; font-size: 11px;
            padding: 6px 14px; border-radius: var(--radius);
            border: 1px solid var(--border); background: var(--surface);
            color: var(--text); cursor: pointer; transition: all 0.15s;
        }
        button:hover { background: var(--surface-hover); border-color: var(--accent-dim); }
        button.primary {
            background: var(--accent); color: var(--bg);
            border-color: var(--accent); font-weight: 500;
        }
        button.primary:hover { background: var(--accent-dim); border-color: var(--accent-dim); }
        button.copied { border-color: var(--success); color: var(--success); }
        button.danger { border-color: var(--block); color: var(--block); }
        button.danger:hover { background: rgba(239,68,68,0.1); }

        /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
        .toolbar { display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap; }
        .toolbar button { display: flex; align-items: center; gap: 5px; }
        .marker-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .marker-dot.anon { background: var(--anon); }
        .marker-dot.block { background: var(--block); }
        .marker-dot.random { background: var(--random); }
        .shortcut { color: var(--text-muted); font-size: 9px; }

        /* ‚îÄ‚îÄ Action bar ‚îÄ‚îÄ */
        .action-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 12px; padding: 0 40px 12px;
        }
        .action-bar button.go-btn {
            font-family: 'Anybody', sans-serif;
            font-weight: 600; font-size: 13px; padding: 10px 40px;
        }

        /* ‚îÄ‚îÄ Context menu ‚îÄ‚îÄ */
        .ctx-menu {
            display: none; position: fixed; background: var(--surface);
            border: 1px solid var(--border); border-radius: var(--radius);
            padding: 4px 0; min-width: 210px; z-index: 1000;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        .ctx-menu.visible { display: block; animation: ctxIn 0.12s ease-out; }
        @keyframes ctxIn {
            from { opacity:0; transform:scale(0.95) translateY(-4px); }
            to { opacity:1; transform:scale(1) translateY(0); }
        }
        .ctx-menu button {
            display: flex; align-items: center; gap: 8px;
            width: 100%; border: none; border-radius: 0;
            padding: 8px 14px; font-size: 12px;
            background: transparent; text-align: left;
        }
        .ctx-menu button:hover { background: var(--surface-hover); }
        .ctx-menu .ctx-shortcut { margin-left: auto; color: var(--text-muted); font-size: 10px; }

        /* ‚îÄ‚îÄ Stats bar ‚îÄ‚îÄ */
        .stats-bar {
            border-top: 1px solid var(--border); padding: 8px 40px;
            display: flex; gap: 24px; font-size: 11px; color: var(--text-muted);
        }
        .stat-item span { color: var(--text); font-weight: 500; }

        /* ‚îÄ‚îÄ Dictionary panel ‚îÄ‚îÄ */
        .dict-panel {
            border-top: 1px solid var(--border);
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .dict-panel.open { max-height: 600px; overflow-y: auto; }
        .dict-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 40px; position: sticky; top: 0;
            background: var(--bg); z-index: 1;
        }
        .dict-header .dict-title {
            font-family: 'Anybody', sans-serif; font-weight: 600;
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--text-muted);
        }
        .dict-actions { display: flex; gap: 6px; }
        .dict-table {
            width: 100%; padding: 0 40px 16px; border-collapse: collapse;
        }
        .dict-table th {
            text-align: left; font-size: 10px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
            padding: 6px 12px; border-bottom: 1px solid var(--border);
        }
        .dict-table td {
            padding: 6px 12px; font-size: 12px;
            border-bottom: 1px solid var(--border);
        }
        .dict-table tr:hover { background: var(--surface-hover); }
        .type-badge {
            font-size: 9px; padding: 2px 6px;
            border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .type-badge.identity { background: rgba(245,158,11,0.12); color: var(--anon); }
        .type-badge.amount { background: rgba(139,92,246,0.12); color: var(--random); }
        .type-badge.date { background: rgba(34,197,94,0.12); color: var(--success); }
        .type-badge.text { background: rgba(113,113,122,0.12); color: var(--text-muted); }
        .type-badge.blocked { background: rgba(239,68,68,0.12); color: var(--block); }
        .dict-table .del-btn {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; padding: 2px 6px; font-size: 14px; border-radius: 4px;
        }
        .dict-table .del-btn:hover { color: var(--block); background: rgba(239,68,68,0.1); }
        .dict-empty {
            text-align: center; padding: 24px 40px;
            color: var(--text-muted); font-size: 12px; font-style: italic;
        }
        .add-entry {
            display: flex; gap: 8px; padding: 0 40px 12px; align-items: center;
        }
        .add-entry input {
            font-family: 'DM Mono', monospace; font-size: 12px;
            padding: 5px 10px; background: var(--surface);
            color: var(--text); border: 1px solid var(--border);
            border-radius: var(--radius); outline: none; flex: 1;
        }
        .add-entry input:focus { border-color: var(--accent-dim); }
        .add-entry input::placeholder { color: var(--text-muted); }

        /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); z-index: 2000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; min-width: 360px; max-width: 500px;
        }
        .modal h3 {
            font-family: 'Anybody', sans-serif; font-weight: 600;
            font-size: 16px; margin-bottom: 16px;
        }
        .modal input[type="text"] {
            font-family: 'DM Mono', monospace; font-size: 13px;
            padding: 8px 12px; background: var(--bg); color: var(--text);
            border: 1px solid var(--border); border-radius: var(--radius);
            outline: none; width: 100%; margin-bottom: 12px;
        }
        .modal input[type="text"]:focus { border-color: var(--accent-dim); }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

        #importFile { display: none; }



        /* ‚îÄ‚îÄ Audit panel ‚îÄ‚îÄ */
        .audit-panel {
            border-top: 1px solid var(--border);
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .audit-panel.open { max-height: 600px; overflow-y: auto; }
        .audit-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 40px; position: sticky; top: 0;
            background: var(--bg); z-index: 1;
        }
        .audit-header .audit-title {
            font-family: 'Anybody', sans-serif; font-weight: 600;
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--text-muted);
        }
        .audit-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px; padding: 0 40px 16px;
        }
        .audit-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 16px;
        }
        .audit-card .audit-card-label {
            font-size: 10px; text-transform: uppercase;
            letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px;
        }
        .audit-card .audit-card-value {
            font-family: 'Anybody', sans-serif; font-weight: 800;
            font-size: 28px; letter-spacing: -1px;
        }
        .audit-card .audit-card-sub {
            font-size: 11px; color: var(--text-muted); margin-top: 4px;
        }
        .audit-card-value.green { color: var(--success); }
        .audit-card-value.amber { color: var(--accent); }
        .audit-card-value.red { color: var(--block); }
        .audit-breakdown {
            padding: 0 40px 16px;
        }
        .audit-breakdown table {
            width: 100%; border-collapse: collapse;
        }
        .audit-breakdown th {
            text-align: left; font-size: 10px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
            padding: 6px 12px; border-bottom: 1px solid var(--border);
        }
        .audit-breakdown td {
            padding: 6px 12px; font-size: 12px;
            border-bottom: 1px solid var(--border);
        }
        .audit-bar {
            height: 6px; border-radius: 3px; background: var(--border);
            overflow: hidden; margin-top: 4px;
        }
        .audit-bar-fill {
            height: 100%; border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* ‚îÄ‚îÄ History panel ‚îÄ‚îÄ */
        .history-panel {
            border-top: 1px solid var(--border);
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .history-panel.open { max-height: 800px; overflow-y: auto; }
        .history-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 40px; position: sticky; top: 0;
            background: var(--bg); z-index: 1;
        }
        .history-header .history-title {
            font-family: 'Anybody', sans-serif; font-weight: 600;
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--text-muted);
        }
        .history-actions { display: flex; gap: 6px; align-items: center; }
        .history-search {
            font-family: 'DM Mono', monospace; font-size: 12px;
            padding: 5px 10px; background: var(--surface);
            color: var(--text); border: 1px solid var(--border);
            border-radius: var(--radius); outline: none; width: 200px;
        }
        .history-search:focus { border-color: var(--accent-dim); }
        .history-search::placeholder { color: var(--text-muted); }
        .history-list { padding: 0 40px 16px; }
        .history-item {
            border: 1px solid var(--border); border-radius: var(--radius);
            margin-bottom: 8px; overflow: hidden;
            transition: border-color 0.15s;
        }
        .history-item:hover { border-color: var(--accent-dim); }
        .history-item-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; background: var(--surface);
            cursor: pointer; gap: 12px;
        }
        .history-item-header:hover { background: var(--surface-hover); }
        .history-meta {
            display: flex; align-items: center; gap: 12px;
            font-size: 11px; color: var(--text-muted); flex: 1;
        }
        .history-meta .history-date { color: var(--text); font-weight: 500; }
        .history-meta .history-project {
            font-size: 9px; padding: 2px 6px;
            border-radius: 4px; background: rgba(245,158,11,0.12);
            color: var(--anon); text-transform: uppercase; letter-spacing: 0.5px;
        }
        .history-meta .history-preview {
            flex: 1; overflow: hidden; text-overflow: ellipsis;
            white-space: nowrap; color: var(--text-muted);
        }
        .history-item-actions { display: flex; gap: 4px; }
        .history-item-actions button {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; padding: 2px 6px; font-size: 12px;
            border-radius: 4px;
        }
        .history-item-actions button:hover { color: var(--text); background: var(--surface-hover); }
        .history-item-actions button.del:hover { color: var(--block); background: rgba(239,68,68,0.1); }
        .history-item-body {
            display: none; padding: 12px;
            border-top: 1px solid var(--border);
        }
        .history-item-body.open { display: block; }
        .history-item-body .history-label {
            font-size: 9px; text-transform: uppercase;
            letter-spacing: 1px; color: var(--text-muted);
            margin-bottom: 4px;
        }
        .history-item-body pre {
            font-family: 'DM Mono', monospace; font-size: 11px;
            line-height: 1.6; color: var(--text);
            background: var(--surface); padding: 10px;
            border-radius: var(--radius); white-space: pre-wrap;
            word-break: break-word; margin-bottom: 10px;
            max-height: 150px; overflow-y: auto;
        }
        .history-stats-row {
            display: flex; gap: 12px; font-size: 10px;
            color: var(--text-muted); margin-top: 6px;
        }
        .history-empty {
            text-align: center; padding: 24px 40px;
            color: var(--text-muted); font-size: 12px; font-style: italic;
        }


        /* ‚îÄ‚îÄ Propagate toast ‚îÄ‚îÄ */
        .toast {
            display: none; position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%); background: var(--surface);
            border: 1px solid var(--accent); border-radius: var(--radius);
            padding: 10px 16px; z-index: 1100;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            font-size: 12px; color: var(--text);
            display: none; align-items: center; gap: 12px;
            animation: toastIn 0.2s ease-out;
        }
        .toast.visible { display: flex; }
        @keyframes toastIn {
            from { opacity:0; transform:translateX(-50%) translateY(10px); }
            to { opacity:1; transform:translateX(-50%) translateY(0); }
        }
        .toast button { font-size: 11px; padding: 4px 12px; }
        .toast .toast-text { color: var(--text-muted); }
        .toast .toast-count { color: var(--accent); font-weight: 500; }

        /* ‚îÄ‚îÄ Marker context menu (for already-marked text) ‚îÄ‚îÄ */
        .marker-ctx-menu {
            display: none; position: fixed; background: var(--surface);
            border: 1px solid var(--border); border-radius: var(--radius);
            padding: 4px 0; min-width: 200px; z-index: 1000;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        .marker-ctx-menu.visible {
            display: block; animation: ctxIn 0.12s ease-out;
        }
        .marker-ctx-menu button {
            display: flex; align-items: center; gap: 8px;
            width: 100%; border: none; border-radius: 0;
            padding: 8px 14px; font-size: 12px;
            background: transparent; text-align: left;
        }
        .marker-ctx-menu button:hover { background: var(--surface-hover); }
        .marker-ctx-menu .sep {
            height: 1px; background: var(--border); margin: 4px 0;
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .workspace { grid-template-columns: 1fr; }
            .panel:first-child { padding-right: 0; border-right: none; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
            .panel:last-child { padding-left: 0; padding-top: 16px; }
            header, .action-bar, .stats-bar, .dict-header, .add-entry { padding-left: 20px; padding-right: 20px; }
            .dict-table { padding: 0 20px 16px; }
            .workspace { padding: 16px 20px; }
            .mode-toggle { margin: 16px 20px 0; }
            header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .history-header, .history-list { padding-left: 20px; padding-right: 20px; }
            .audit-header, .audit-grid, .audit-breakdown { padding-left: 20px; padding-right: 20px; }
        }
    </style>
</head>
<body>

<!-- Privacy banner -->
<div class="privacy-banner">
    <span class="dot"></span>
    100% LOCAL ‚Äî No data leaves your browser. No server, no account, no tracking.
    <a href="https://buymeacoffee.com/promptmask" target="_blank" style="margin-left:12px; color:var(--accent); text-decoration:none; opacity:0.7">‚òï Support this project</a><span style="margin-left:4px; opacity:0.5">Press F12 ‚Üí Network tab to verify.</span>
</div>

<!-- Header -->
<header>
    <div class="header-left">
        <h1>üé≠ prompt-mask</h1>
        <p class="tagline">Anonymize your prompts before sending them to AI.</p>
    </div>
    <div class="header-right">
        <div class="project-selector">
            <label>Project:</label>
            <select id="projectSelect" onchange="switchProject()"></select>
            <button onclick="showNewProjectModal()" title="New project">+</button>
            <button onclick="deleteCurrentProject()" class="danger" title="Delete project">√ó</button>
        </div>
    </div>
</header>

<!-- Mode toggle -->
<div class="mode-toggle">
    <button id="modeSealBtn" class="active" onclick="setMode('seal')">‚¨á SEAL ‚Äî Mask before sending</button>
    <button id="modeUnsealBtn" onclick="setMode('unseal')">‚¨Ü UNSEAL ‚Äî Restore AI response</button>
</div>

<!-- Workspace -->
<div class="workspace">
    <!-- Input panel -->
    <div class="panel">
        <div class="panel-header">
            <span class="panel-label" id="inputLabel">Your prompt</span>
            <button id="pasteBtn" onclick="pasteFromClipboard()" style="display:none">üìã Paste from clipboard</button>
        </div>
        <div id="toolbarWrap">
            <div class="toolbar" id="sealToolbar">
                <button onclick="wrapSelection('anon')" title="Replace with fake data ‚Äî reversible with unseal">
                    <span class="marker-dot anon"></span> Anonymize <span class="shortcut">Ctrl+1</span>
                </button>
                <button onclick="wrapSelection('block')" title="Permanently redact ‚Äî NOT reversible">
                    <span class="marker-dot block"></span> Block <span class="shortcut">Ctrl+2</span>
                </button>
                <button onclick="wrapSelection('random')" title="Replace with random value ‚Äî reversible with unseal">
                    <span class="marker-dot random"></span> Randomize <span class="shortcut">Ctrl+3</span>
                </button>
            </div>
        </div>
        <div class="panel-hint" id="inputHint">***{} anonymize (reversible) ¬∑ ---{} block (permanent) ¬∑ +++{} randomize (reversible)</div>
        <textarea id="input" placeholder="Type or paste your prompt here..."></textarea>
    </div>
    <!-- Output panel -->
    <div class="panel">
        <div class="panel-header">
            <span class="panel-label" id="outputLabel">Masked output</span>
            <button id="copyBtn" onclick="copyOutput()">Copy</button>
        </div>
        <div class="panel-hint" id="outputHint">Copy this and paste it into your AI tool.</div>
        <textarea id="output" readonly placeholder="Masked prompt will appear here..."></textarea>
    </div>
</div>

<!-- Action bar -->
<div class="action-bar">
    <button class="primary go-btn" id="goBtn" onclick="go()">‚¨á SEAL</button>
    <button onclick="clearAll()">Clear</button>
</div>

<!-- Stats bar -->
<div class="stats-bar">
    <div class="stat-item">Markers: <span id="statMarkers">0</span></div>
    <div class="stat-item">Dictionary: <span id="statDict">0</span> entries</div>
    <div class="stat-item">
        <span class="marker-dot anon"></span>&nbsp;<span id="statAnon">0</span>&emsp;
        <span class="marker-dot block"></span>&nbsp;<span id="statBlock">0</span>&emsp;
        <span class="marker-dot random"></span>&nbsp;<span id="statRandom">0</span>
    </div>
    <div style="margin-left:auto">
        <button onclick="toggleDict()" id="dictToggleBtn">üìñ Dictionary</button>
        <button onclick="toggleHistory()" id="historyToggleBtn" style="margin-left:4px">üìã History</button>
        <button onclick="toggleAudit()" id="auditToggleBtn" style="margin-left:4px">üìä Audit</button>
    </div>
</div>

<!-- Dictionary panel -->
<div class="dict-panel" id="dictPanel">
    <div class="dict-header">
        <span class="dict-title">üìñ Dictionary ‚Äî <span id="dictProjectLabel"></span></span>
        <div class="dict-actions">
            <button onclick="exportDict()">Export</button>
            <button onclick="document.getElementById('importFile').click()">Import</button>
            <input type="file" id="importFile" accept=".json" onchange="importDict(event)">
            <button class="danger" onclick="clearDict()">Clear all</button>
        </div>
    </div>
    <div class="add-entry">
        <input type="text" id="addReal" placeholder="Real value...">
        <input type="text" id="addFake" placeholder="Masked value...">
        <button onclick="addManualEntry()">+ Add</button>
    </div>
    <div id="dictContent"></div>
</div>



<!-- Audit panel -->
<div class="audit-panel" id="auditPanel">
    <div class="audit-header">
        <span class="audit-title">üìä Audit Overview</span>
    </div>
    <div class="audit-grid" id="auditGrid"></div>
    <div class="audit-breakdown" id="auditBreakdown"></div>
</div>

<!-- History panel -->
<div class="history-panel" id="historyPanel">
    <div class="history-header">
        <span class="history-title">üìã Prompt History ‚Äî <span id="historyCount">0</span> entries</span>
        <div class="history-actions">
            <input type="text" class="history-search" id="historySearch" placeholder="Search prompts..." oninput="renderHistory()">
            <button onclick="exportHistory()">Export</button>
            <button class="danger" onclick="clearHistory()">Clear all</button>
        </div>
    </div>
    <div class="history-list" id="historyList"></div>
</div>

<!-- Context menu -->
<div class="ctx-menu" id="ctxMenu">
    <button onclick="wrapSelection('anon')">
        <span class="marker-dot anon"></span> Anonymize <span class="ctx-shortcut">Ctrl+1</span>
    </button>
    <button onclick="wrapSelection('block')">
        <span class="marker-dot block"></span> Block <span class="ctx-shortcut">Ctrl+2</span>
    </button>
    <button onclick="wrapSelection('random')">
        <span class="marker-dot random"></span> Randomize <span class="ctx-shortcut">Ctrl+3</span>
    </button>
</div>


<!-- Propagate toast -->
<div class="toast" id="propagateToast">
    <span class="toast-text">Found <span class="toast-count" id="propagateCount">0</span> other occurrences.</span>
    <button class="primary" onclick="propagateMarker()">Propagate all</button>
    <button onclick="hideToast()">Dismiss</button>
</div>

<!-- Marker context menu (right-click on already-marked text) -->
<div class="marker-ctx-menu" id="markerCtxMenu">
    <button onclick="removeMarkerAtCursor()">
        ‚úï Remove marker
    </button>
    <button id="propagateFromCtx" onclick="propagateFromMarkerCtx()" style="display:none">
        ‚ü≥ Propagate (<span id="propagateCtxCount">0</span> others)
    </button>
    <div class="sep"></div>
    <button onclick="changeMarkerType('anon')">
        <span class="marker-dot anon"></span> Change to Anonymize
    </button>
    <button onclick="changeMarkerType('block')">
        <span class="marker-dot block"></span> Change to Block
    </button>
    <button onclick="changeMarkerType('random')">
        <span class="marker-dot random"></span> Change to Randomize
    </button>
</div>

<!-- New project modal -->
<div class="modal-overlay" id="newProjectModal">
    <div class="modal">
        <h3>New Project</h3>
        <input type="text" id="newProjectName" placeholder="Project name..." onkeydown="if(event.key==='Enter')createProject()">
        <div class="modal-actions">
            <button onclick="closeModal()">Cancel</button>
            <button class="primary" onclick="createProject()">Create</button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentProject = 'default';
let projects = {};
let currentMode = 'seal'; // 'seal' or 'unseal'

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODE SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(mode) {
    currentMode = mode;
    const isSeal = mode === 'seal';

    document.getElementById('modeSealBtn').classList.toggle('active', isSeal);
    document.getElementById('modeUnsealBtn').classList.toggle('active', !isSeal);

    document.getElementById('inputLabel').textContent = isSeal ? 'Your prompt' : 'Paste AI response here';
    document.getElementById('outputLabel').textContent = isSeal ? 'Masked output' : 'Unmasked result (real data restored)';

    document.getElementById('inputHint').textContent = isSeal
        ? '***{} anonymize (reversible) ¬∑ ---{} block (permanent) ¬∑ +++{} randomize (reversible)'
        : 'Paste the AI response below. All masked names/values will be restored to the real ones.';
    document.getElementById('outputHint').textContent = isSeal
        ? 'Copy this and paste it into your AI tool.'
        : 'This is the final result with your real data.';

    document.getElementById('input').placeholder = isSeal
        ? 'Type or paste your prompt here...'
        : 'Paste the AI response here...\n\nAll fake names and values from the dictionary will be\nreplaced with the real ones.';

    document.getElementById('sealToolbar').style.display = isSeal ? 'flex' : 'none';
    document.getElementById('pasteBtn').style.display = isSeal ? 'none' : 'inline-flex';

    document.getElementById('goBtn').textContent = isSeal ? '‚¨á SEAL' : '‚¨Ü UNSEAL';
    document.getElementById('goBtn').classList.toggle('primary', isSeal);

    document.getElementById('input').value = '';
    document.getElementById('output').value = '';
}

function go() {
    if (currentMode === 'seal') seal();
    else unseal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PASTE FROM CLIPBOARD (unseal mode)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pasteFromClipboard() {
    navigator.clipboard.readText().then(text => {
        document.getElementById('input').value = text;
    }).catch(() => {
        document.getElementById('input').focus();
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAKE DATA POOLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FAKE_NAMES = [
    "Alex Morgan", "Sam Rivera", "Jordan Chen", "Casey Brooks",
    "Riley Park", "Quinn Foster", "Avery Lane", "Taylor Nash",
    "Morgan Ellis", "Jamie Cross", "Drew Palmer", "Blake Warren",
    "Reese Conrad", "Parker Stone", "Sage Mitchell", "Robin Clarke"
];
const FAKE_COMPANIES = [
    "Vertex Labs", "NovaBridge", "Apex Dynamics", "Cobalt Systems",
    "IronLeaf Corp", "Prism Works", "Zenith Group", "Atlas Digital",
    "Onyx Partners", "Helix Solutions", "Lunar Industries", "Forge & Co"
];
const FAKE_EMAILS = [
    "contact@vertex-labs.com", "info@novabridge.io", "hello@apex-dyn.com",
    "team@cobalt-sys.com", "admin@ironleaf.co", "mail@prismworks.io"
];
const FAKE_PROJECTS = [
    "Project Horizon", "Project Nebula", "Project Titan", "Project Echo",
    "Project Meridian", "Project Onyx", "Project Vanguard", "Project Apex"
];

let nameIdx = 0, companyIdx = 0, emailIdx = 0, projectIdx = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDict() { return projects[currentProject]?.dict || {}; }
function getRdict() { return projects[currentProject]?.rdict || {}; }
function getTypes() { return projects[currentProject]?.types || {}; }

function setMapping(real, fake, type) {
    if (!projects[currentProject]) initProject(currentProject);
    projects[currentProject].dict[real] = fake;
    projects[currentProject].rdict[fake] = real;
    projects[currentProject].types[real] = type || 'identity';
}

function removeMapping(real) {
    const p = projects[currentProject];
    if (!p) return;
    const fake = p.dict[real];
    delete p.dict[real];
    delete p.types[real];
    if (fake) delete p.rdict[fake];
}

function initProject(name) {
    if (!projects[name]) projects[name] = { dict: {}, rdict: {}, types: {} };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TYPE DETECTION + FAKE GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function detectType(value) {
    const v = value.trim();
    if (/^[\w.+-]+@[\w-]+\.[\w.]+$/.test(v)) return 'email';
    if (/\b(project|projet)\s/i.test(v)) return 'project';
    if (/\b(inc|corp|ltd|sas|sarl|gmbh|llc|group|labs?|co|tech|systems|dynamics|digital|solutions|partners|industries|works)\b/i.test(v)
        || /[A-Z].*[A-Z].*(&|\band\b)/.test(v)) return 'company';
    if (/^[\d\s.,]+[‚Ç¨$¬£¬•kKmM%]?$/.test(v)) return 'amount';
    return 'name';
}

function generateFake(value, type) {
    switch (type) {
        case 'email':    return FAKE_EMAILS[emailIdx++ % FAKE_EMAILS.length];
        case 'company':  return FAKE_COMPANIES[companyIdx++ % FAKE_COMPANIES.length];
        case 'project':  return FAKE_PROJECTS[projectIdx++ % FAKE_PROJECTS.length];
        case 'amount':   return randomizeValue(value);
        default:         return FAKE_NAMES[nameIdx++ % FAKE_NAMES.length];
    }
}

function randomizeValue(value) {
    const v = value.trim();

    const amountMatch = v.match(/^([^\d]*)(\d[\d\s.,]*)(\s*[‚Ç¨$¬£¬•kKmM%]*.*)$/);
    if (amountMatch) {
        const prefix = amountMatch[1];
        const numStr = amountMatch[2].replace(/[\s,]/g, '');
        const suffix = amountMatch[3];
        const num = parseFloat(numStr);
        if (!isNaN(num)) {
            const factor = 0.7 + Math.random() * 0.6;
            return prefix + Math.round(num * factor) + suffix;
        }
    }

    const dateMatch = v.match(/^(\d{1,4})([\/-])(\d{1,2})\2(\d{1,4})$/);
    if (dateMatch) {
        const offset = Math.floor(Math.random() * 60) - 30;
        const parts = [dateMatch[1], dateMatch[3], dateMatch[4]].map(Number);
        const sep = dateMatch[2];
        let d;
        if (parts[2] > 31) {
            d = new Date(parts[2], parts[1] - 1, parts[0]);
        } else {
            d = new Date(parts[0], parts[1] - 1, parts[2]);
        }
        if (!isNaN(d.getTime())) {
            d.setDate(d.getDate() + offset);
            const pad = n => String(n).padStart(2, '0');
            if (parts[2] > 31) {
                return pad(d.getDate()) + sep + pad(d.getMonth()+1) + sep + d.getFullYear();
            } else {
                return d.getFullYear() + sep + pad(d.getMonth()+1) + sep + pad(d.getDate());
            }
        }
    }

    const chars = v.split('');
    for (let i = chars.length - 1; i > 0; i--) {
        const c = chars[i];
        if (/[a-z]/.test(c)) chars[i] = String.fromCharCode(97 + Math.floor(Math.random() * 26));
        else if (/[A-Z]/.test(c)) chars[i] = String.fromCharCode(65 + Math.floor(Math.random() * 26));
        else if (/[0-9]/.test(c)) chars[i] = String(Math.floor(Math.random() * 10));
    }
    return chars.join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function seal() {
    const input = document.getElementById('input').value;
    let output = input;
    let anonCount = 0, blockCount = 0, randomCount = 0;
    const dict = getDict();

    output = output.replace(/\*\*\*\{([^}]+)\}/g, (_, value) => {
        anonCount++;
        if (dict[value]) return dict[value];
        const type = detectType(value);
        const fake = generateFake(value, type);
        setMapping(value, fake, type);
        return fake;
    });

    const redactedMap = {};
    let redactedIdx = 0;
    output = output.replace(/---\{([^}]*)\}/g, (_, value) => {
        blockCount++;
        if (value && redactedMap[value] !== undefined) {
            return '[REDACTED:' + redactedMap[value] + ']';
        }
        redactedIdx++;
        if (value) redactedMap[value] = redactedIdx;
        return '[REDACTED:' + redactedIdx + ']';
    });

    output = output.replace(/\+\+\+\{([^}]+)\}/g, (_, value) => {
        randomCount++;
        if (dict[value]) return dict[value];
        const fake = randomizeValue(value);
        const type = /\d/.test(value) ? (/[‚Ç¨$¬£¬•%]/.test(value) ? 'amount' : 'date') : 'text';
        setMapping(value, fake, type);
        return fake;
    });

    document.getElementById('output').value = output;
    updateStats(anonCount, blockCount, randomCount);
    savePromptToHistory(input, output, anonCount, blockCount, randomCount);
    saveAll();
    renderDict();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNSEAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function unseal() {
    const input = document.getElementById('input').value;
    let output = input;
    const rdict = getRdict();
    const fakes = Object.keys(rdict).sort((a, b) => b.length - a.length);
    for (const fake of fakes) {
        output = output.split(fake).join(rdict[fake]);
    }
    document.getElementById('output').value = output;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WRAP SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastWrappedText = '';
let lastWrappedType = '';

function wrapSelection(type) {
    const textarea = document.getElementById('input');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    hideContextMenu();
    hideMarkerCtxMenu();
    if (!selected) return;
    const markers = { anon: '***', block: '---', random: '+++' };
    const wrapped = markers[type] + '{' + selected + '}';
    textarea.value = textarea.value.substring(0, start) + wrapped + textarea.value.substring(end);
    const newPos = start + wrapped.length;
    textarea.selectionStart = newPos;
    textarea.selectionEnd = newPos;
    textarea.focus();

    // Check for other occurrences to propagate
    lastWrappedText = selected;
    lastWrappedType = type;
    const count = countUnwrappedOccurrences(textarea.value, selected);
    if (count > 0) {
        document.getElementById('propagateCount').textContent = count;
        showToast();
    }
}

function countUnwrappedOccurrences(text, word) {
    if (!word) return 0;
    let count = 0;
    let pos = 0;
    const escaped = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // Match word NOT already inside markers: not preceded by ***{ or ---{ or +++{
    const regex = new RegExp('(?<!\\*\\*\\*\\{)(?<!---\\{)(?<!\\+\\+\\+\\{)' + escaped + '(?!\\})', 'g');
    const matches = text.match(regex);
    return matches ? matches.length : 0;
}

function propagateMarker() {
    if (!lastWrappedText || !lastWrappedType) return;
    const textarea = document.getElementById('input');
    const markers = { anon: '***', block: '---', random: '+++' };
    const marker = markers[lastWrappedType];
    const text = lastWrappedText;
    const cursorPos = textarea.selectionStart;

    // Replace all unwrapped occurrences
    let result = '';
    let i = 0;
    const val = textarea.value;
    while (i < val.length) {
        // Check if we're at a marker already
        let isMarked = false;
        for (const m of ['***', '---', '+++']) {
            if (val.substring(i, i + m.length + 1) === m + '{') {
                // Skip to closing }
                const closeIdx = val.indexOf('}', i + m.length + 1);
                if (closeIdx !== -1) {
                    result += val.substring(i, closeIdx + 1);
                    i = closeIdx + 1;
                    isMarked = true;
                    break;
                }
            }
        }
        if (isMarked) continue;

        // Check if text matches at this position
        if (val.substring(i, i + text.length) === text) {
            result += marker + '{' + text + '}';
            i += text.length;
        } else {
            result += val[i];
            i++;
        }
    }

    textarea.value = result;
    hideToast();
    lastWrappedText = '';
    lastWrappedType = '';
}

function showToast() {
    document.getElementById('propagateToast').classList.add('visible');
    // Auto-hide after 6s
    clearTimeout(window._toastTimer);
    window._toastTimer = setTimeout(hideToast, 6000);
}

function hideToast() {
    document.getElementById('propagateToast').classList.remove('visible');
    clearTimeout(window._toastTimer);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTEXT MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ctxMenu = document.getElementById('ctxMenu');
const markerCtxMenu = document.getElementById('markerCtxMenu');
let markerCtxStart = -1;
let markerCtxEnd = -1;

document.getElementById('input').addEventListener('contextmenu', (e) => {
    if (currentMode !== 'seal') return;
    const textarea = document.getElementById('input');
    const cursor = textarea.selectionStart;
    const val = textarea.value;

    // Check if cursor is inside a marker
    const markerInfo = findMarkerAtPosition(val, cursor);
    if (markerInfo) {
        e.preventDefault();
        hideContextMenu();
        markerCtxStart = markerInfo.start;
        markerCtxEnd = markerInfo.end;
        markerCtxMenu.style.left = e.clientX + 'px';
        markerCtxMenu.style.top = e.clientY + 'px';
        // Check if propagation is possible
        const propCount = countUnwrappedOccurrences(val, markerInfo.inner);
        const propBtn = document.getElementById('propagateFromCtx');
        if (propCount > 0) {
            document.getElementById('propagateCtxCount').textContent = propCount;
            propBtn.style.display = 'flex';
        } else {
            propBtn.style.display = 'none';
        }
        markerCtxMenu.classList.add('visible');
        return;
    }

    const selected = val.substring(textarea.selectionStart, textarea.selectionEnd);
    if (selected) {
        e.preventDefault();
        hideMarkerCtxMenu();
        ctxMenu.style.left = e.clientX + 'px';
        ctxMenu.style.top = e.clientY + 'px';
        ctxMenu.classList.add('visible');
    }
});

document.addEventListener('click', () => { hideContextMenu(); hideMarkerCtxMenu(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { hideContextMenu(); hideMarkerCtxMenu(); } });
function hideContextMenu() { ctxMenu.classList.remove('visible'); }
function hideMarkerCtxMenu() { markerCtxMenu.classList.remove('visible'); }

function findMarkerAtPosition(text, pos) {
    const markers = ['***', '---', '+++'];
    for (const m of markers) {
        let searchStart = 0;
        while (true) {
            const openIdx = text.indexOf(m + '{', searchStart);
            if (openIdx === -1) break;
            const closeIdx = text.indexOf('}', openIdx + m.length + 1);
            if (closeIdx === -1) break;
            if (pos >= openIdx && pos <= closeIdx) {
                const inner = text.substring(openIdx + m.length + 1, closeIdx);
                return { start: openIdx, end: closeIdx + 1, marker: m, inner: inner };
            }
            searchStart = closeIdx + 1;
        }
    }
    return null;
}

function removeMarkerAtCursor() {
    if (markerCtxStart === -1) return;
    const textarea = document.getElementById('input');
    const val = textarea.value;
    const markerInfo = findMarkerAtPosition(val, markerCtxStart);
    if (!markerInfo) return;
    textarea.value = val.substring(0, markerInfo.start) + markerInfo.inner + val.substring(markerInfo.end);
    hideMarkerCtxMenu();
    textarea.focus();
}

function propagateFromMarkerCtx() {
    if (markerCtxStart === -1) return;
    const textarea = document.getElementById('input');
    const val = textarea.value;
    const markerInfo = findMarkerAtPosition(val, markerCtxStart);
    if (!markerInfo) return;
    lastWrappedText = markerInfo.inner;
    lastWrappedType = markerInfo.marker === '***' ? 'anon' : markerInfo.marker === '---' ? 'block' : 'random';
    hideMarkerCtxMenu();
    propagateMarker();
}

function changeMarkerType(type) {
    if (markerCtxStart === -1) return;
    const textarea = document.getElementById('input');
    const val = textarea.value;
    const markerInfo = findMarkerAtPosition(val, markerCtxStart);
    if (!markerInfo) return;
    const markers = { anon: '***', block: '---', random: '+++' };
    const newMarked = markers[type] + '{' + markerInfo.inner + '}';
    textarea.value = val.substring(0, markerInfo.start) + newMarked + val.substring(markerInfo.end);
    hideMarkerCtxMenu();
    textarea.focus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD SHORTCUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown', (e) => {
    if (currentMode !== 'seal') return;
    if (e.ctrlKey || e.metaKey) {
        if (e.key === '1') { e.preventDefault(); wrapSelection('anon'); }
        if (e.key === '2') { e.preventDefault(); wrapSelection('block'); }
        if (e.key === '3') { e.preventDefault(); wrapSelection('random'); }
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COPY / CLEAR / STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyOutput() {
    const output = document.getElementById('output');
    navigator.clipboard.writeText(output.value).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.textContent = '‚úì Copied';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
    });
}

function clearAll() {
    document.getElementById('input').value = '';
    document.getElementById('output').value = '';
    updateStats(0, 0, 0);
}

function updateStats(anon, block, random) {
    document.getElementById('statMarkers').textContent = anon + block + random;
    document.getElementById('statDict').textContent = Object.keys(getDict()).length;
    document.getElementById('statAnon').textContent = anon;
    document.getElementById('statBlock').textContent = block;
    document.getElementById('statRandom').textContent = random;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DICTIONARY PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDict() {
    document.getElementById('dictPanel').classList.toggle('open');
    if (document.getElementById('dictPanel').classList.contains('open')) {
        document.getElementById('historyPanel').classList.remove('open');
        document.getElementById('auditPanel').classList.remove('open');
    }
    renderDict();
}

function renderDict() {
    const dict = getDict();
    const types = getTypes();
    const container = document.getElementById('dictContent');
    const entries = Object.entries(dict);

    document.getElementById('dictProjectLabel').textContent = currentProject;
    document.getElementById('statDict').textContent = entries.length;

    if (entries.length === 0) {
        container.innerHTML = '<div class="dict-empty">No entries yet. Seal a prompt or add entries manually.</div>';
        return;
    }

    let html = '<table class="dict-table"><thead><tr><th>Real</th><th>Masked</th><th>Type</th><th></th></tr></thead><tbody>';
    for (const [real, fake] of entries) {
        const type = types[real] || 'identity';
        html += '<tr><td>' + escHtml(real) + '</td><td>' + escHtml(fake) + '</td><td><span class="type-badge ' + type + '">' + type + '</span></td><td><button class="del-btn" onclick="deleteEntry(\'' + escAttr(real) + '\')" title="Delete">√ó</button></td></tr>';
    }
    html += '</tbody></table>';
    container.innerHTML = html;
}

function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escAttr(s) { return s.replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

function deleteEntry(real) {
    removeMapping(real);
    saveAll();
    renderDict();
    updateStats(0, 0, 0);
}

function clearDict() {
    if (!confirm('Clear all entries for "' + currentProject + '"?')) return;
    projects[currentProject] = { dict: {}, rdict: {}, types: {} };
    saveAll();
    renderDict();
    updateStats(0, 0, 0);
}

function addManualEntry() {
    const real = document.getElementById('addReal').value.trim();
    const fake = document.getElementById('addFake').value.trim();
    if (!real || !fake) return;
    setMapping(real, fake, detectType(real));
    document.getElementById('addReal').value = '';
    document.getElementById('addFake').value = '';
    saveAll();
    renderDict();
    updateStats(0, 0, 0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT / IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportDict() {
    const data = {
        project: currentProject, version: 1,
        exported: new Date().toISOString(),
        entries: Object.entries(getDict()).map(([real, fake]) => ({
            real, fake, type: getTypes()[real] || 'identity'
        }))
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'prompt-mask_' + currentProject + '_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function importDict(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (!data.entries || !Array.isArray(data.entries)) { alert('Invalid file format.'); return; }
            const target = data.project || currentProject;
            if (!projects[target]) initProject(target);
            for (const entry of data.entries) {
                projects[target].dict[entry.real] = entry.fake;
                projects[target].rdict[entry.fake] = entry.real;
                projects[target].types[entry.real] = entry.type || 'identity';
            }
            if (target !== currentProject) { currentProject = target; renderProjectSelect(); }
            saveAll(); renderDict(); updateStats(0, 0, 0);
        } catch (err) { alert('Error reading file: ' + err.message); }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProjectSelect() {
    const select = document.getElementById('projectSelect');
    select.innerHTML = '';
    for (const name of Object.keys(projects)) {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        if (name === currentProject) opt.selected = true;
        select.appendChild(opt);
    }
}

function switchProject() {
    currentProject = document.getElementById('projectSelect').value;
    saveAll(); renderDict(); updateStats(0, 0, 0);
}

function showNewProjectModal() {
    document.getElementById('newProjectModal').classList.add('visible');
    document.getElementById('newProjectName').value = '';
    document.getElementById('newProjectName').focus();
}

function closeModal() { document.getElementById('newProjectModal').classList.remove('visible'); }

function createProject() {
    const name = document.getElementById('newProjectName').value.trim();
    if (!name) return;
    if (projects[name]) { alert('Project already exists.'); return; }
    initProject(name);
    currentProject = name;
    saveAll(); renderProjectSelect(); renderDict(); updateStats(0, 0, 0);
    closeModal();
}

function deleteCurrentProject() {
    if (currentProject === 'default') { alert('Cannot delete the default project.'); return; }
    if (!confirm('Delete project "' + currentProject + '" and all its entries?')) return;
    delete projects[currentProject];
    currentProject = 'default';
    saveAll(); renderProjectSelect(); renderDict(); updateStats(0, 0, 0);
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MINI AUDIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleAudit() {
    const panel = document.getElementById('auditPanel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
        document.getElementById('dictPanel').classList.remove('open');
        document.getElementById('historyPanel').classList.remove('open');
        renderAudit();
    }
}

function renderAudit() {
    const grid = document.getElementById('auditGrid');
    const breakdown = document.getElementById('auditBreakdown');

    // Compute stats from history
    const totalPrompts = history.length;
    let totalAnon = 0, totalBlock = 0, totalRandom = 0;
    const projectStats = {};
    const last30 = [];
    const now = Date.now();
    const thirtyDays = 30 * 24 * 60 * 60 * 1000;

    for (const entry of history) {
        totalAnon += entry.stats.anon;
        totalBlock += entry.stats.block;
        totalRandom += entry.stats.random;

        if (!projectStats[entry.project]) {
            projectStats[entry.project] = { prompts: 0, anon: 0, block: 0, random: 0 };
        }
        projectStats[entry.project].prompts++;
        projectStats[entry.project].anon += entry.stats.anon;
        projectStats[entry.project].block += entry.stats.block;
        projectStats[entry.project].random += entry.stats.random;

        if (now - new Date(entry.timestamp).getTime() < thirtyDays) {
            last30.push(entry);
        }
    }

    const totalMarkers = totalAnon + totalBlock + totalRandom;
    const dictSize = Object.keys(getDict()).length;

    // Privacy score: % of prompts that have at least one marker
    const promptsWithMarkers = history.filter(h => (h.stats.anon + h.stats.block + h.stats.random) > 0).length;
    const privacyScore = totalPrompts > 0 ? Math.round((promptsWithMarkers / totalPrompts) * 100) : 0;
    const scoreClass = privacyScore >= 80 ? 'green' : privacyScore >= 50 ? 'amber' : 'red';

    // Render cards
    grid.innerHTML =
        '<div class="audit-card">' +
            '<div class="audit-card-label">Total prompts sealed</div>' +
            '<div class="audit-card-value">' + totalPrompts + '</div>' +
            '<div class="audit-card-sub">' + last30.length + ' in the last 30 days</div>' +
        '</div>' +
        '<div class="audit-card">' +
            '<div class="audit-card-label">Data points protected</div>' +
            '<div class="audit-card-value">' + totalMarkers + '</div>' +
            '<div class="audit-card-sub">' +
                '<span style="color:var(--anon)">‚óè ' + totalAnon + ' anonymized</span> &nbsp;' +
                '<span style="color:var(--block)">‚óè ' + totalBlock + ' blocked</span> &nbsp;' +
                '<span style="color:var(--random)">‚óè ' + totalRandom + ' randomized</span>' +
            '</div>' +
        '</div>' +
        '<div class="audit-card">' +
            '<div class="audit-card-label">Privacy score</div>' +
            '<div class="audit-card-value ' + scoreClass + '">' + privacyScore + '%</div>' +
            '<div class="audit-bar"><div class="audit-bar-fill" style="width:' + privacyScore + '%;background:var(--' + scoreClass + ')"></div></div>' +
            '<div class="audit-card-sub">% of prompts with at least one marker</div>' +
        '</div>' +
        '<div class="audit-card">' +
            '<div class="audit-card-label">Dictionary size</div>' +
            '<div class="audit-card-value">' + dictSize + '</div>' +
            '<div class="audit-card-sub">Active project: ' + escHtml(currentProject) + '</div>' +
        '</div>';

    // Render project breakdown
    const projectEntries = Object.entries(projectStats);
    if (projectEntries.length === 0) {
        breakdown.innerHTML = '';
        return;
    }

    let html = '<table><thead><tr><th>Project</th><th>Prompts</th><th>Anonymized</th><th>Blocked</th><th>Randomized</th><th>Total</th></tr></thead><tbody>';
    for (const [name, stats] of projectEntries.sort((a,b) => b[1].prompts - a[1].prompts)) {
        const total = stats.anon + stats.block + stats.random;
        html += '<tr><td>' + escHtml(name) + '</td><td>' + stats.prompts + '</td><td>' + stats.anon + '</td><td>' + stats.block + '</td><td>' + stats.random + '</td><td>' + total + '</td></tr>';
    }
    html += '</tbody></table>';
    breakdown.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROMPT HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let history = [];

function savePromptToHistory(original, sealed, anonCount, blockCount, randomCount) {
    const entry = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        timestamp: new Date().toISOString(),
        project: currentProject,
        original: original,
        sealed: sealed,
        stats: { anon: anonCount, block: blockCount, random: randomCount },
    };
    history.unshift(entry);
    if (history.length > 500) history = history.slice(0, 500);
    saveHistory();
    renderHistory();
}

function toggleHistory() {
    const panel = document.getElementById('historyPanel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
        document.getElementById('dictPanel').classList.remove('open');
        document.getElementById('auditPanel').classList.remove('open');
    }
    renderHistory();
}

function renderHistory() {
    const container = document.getElementById('historyList');
    const search = (document.getElementById('historySearch').value || '').toLowerCase();

    let filtered = history;
    if (search) {
        filtered = history.filter(h =>
            h.original.toLowerCase().includes(search) ||
            h.sealed.toLowerCase().includes(search) ||
            h.project.toLowerCase().includes(search)
        );
    }

    document.getElementById('historyCount').textContent = history.length;

    if (filtered.length === 0) {
        container.innerHTML = '<div class="history-empty">' +
            (history.length === 0 ? 'No prompts yet. History is saved automatically when you seal.' : 'No prompts match your search.') +
            '</div>';
        return;
    }

    let html = '';
    for (const entry of filtered) {
        const date = new Date(entry.timestamp);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const preview = entry.original.replace(/[\*\-\+]{3}\{([^}]*)\}/g, '$1').slice(0, 80);
        const totalMarkers = entry.stats.anon + entry.stats.block + entry.stats.random;

        html += '<div class="history-item">' +
            '<div class="history-item-header" onclick="toggleHistoryItem(\'' + entry.id + '\')">' +
            '<div class="history-meta">' +
            '<span class="history-date">' + dateStr + '</span>' +
            '<span class="history-project">' + escHtml(entry.project) + '</span>' +
            '<span class="history-preview">' + escHtml(preview) + (entry.original.length > 80 ? '...' : '') + '</span>' +
            '</div>' +
            '<div class="history-item-actions">' +
            '<button onclick="event.stopPropagation();reusePrompt(\''+entry.id+'\');" title="Reuse in editor">‚Ü©</button>' +
            '<button class="del" onclick="event.stopPropagation();deleteHistoryItem(\''+entry.id+'\');" title="Delete">√ó</button>' +
            '</div>' +
            '</div>' +
            '<div class="history-item-body" id="hist-' + entry.id + '">' +
            '<div class="history-label">Original prompt</div>' +
            '<pre>' + escHtml(entry.original) + '</pre>' +
            '<div class="history-label">Sealed output</div>' +
            '<pre>' + escHtml(entry.sealed) + '</pre>' +
            '<div class="history-stats-row">' +
            '<span>Anonymized: ' + entry.stats.anon + '</span>' +
            '<span>Blocked: ' + entry.stats.block + '</span>' +
            '<span>Randomized: ' + entry.stats.random + '</span>' +
            '<span>Total markers: ' + totalMarkers + '</span>' +
            '</div>' +
            '</div>' +
            '</div>';
    }
    container.innerHTML = html;
}

function toggleHistoryItem(id) {
    const body = document.getElementById('hist-' + id);
    if (body) body.classList.toggle('open');
}

function reusePrompt(id) {
    const entry = history.find(h => h.id === id);
    if (!entry) return;
    setMode('seal');
    document.getElementById('input').value = entry.original;
}

function deleteHistoryItem(id) {
    history = history.filter(h => h.id !== id);
    saveHistory();
    renderHistory();
}

function clearHistory() {
    if (!confirm('Delete all prompt history?')) return;
    history = [];
    saveHistory();
    renderHistory();
}

function exportHistory() {
    const data = {
        version: 1,
        exported: new Date().toISOString(),
        count: history.length,
        prompts: history
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'prompt-mask_history_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function saveHistory() {
    try {
        localStorage.setItem('promptmask_history', JSON.stringify(history));
    } catch (e) { /* silent */ }
}

function loadHistory() {
    try {
        const h = localStorage.getItem('promptmask_history');
        if (h) history = JSON.parse(h);
    } catch (e) { /* silent */ }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveAll() {
    try {
        localStorage.setItem('promptmask_projects', JSON.stringify(projects));
        localStorage.setItem('promptmask_current', currentProject);
    } catch (e) { /* silent */ }
}

function loadAll() {
    try {
        const p = localStorage.getItem('promptmask_projects');
        const c = localStorage.getItem('promptmask_current');
        if (p) projects = JSON.parse(p);
        if (c && projects[c]) currentProject = c;
        const oldDict = localStorage.getItem('promptmask_dict');
        const oldRdict = localStorage.getItem('promptmask_rdict');
        if (oldDict && !projects['default']?.dict) {
            initProject('default');
            projects['default'].dict = JSON.parse(oldDict);
            if (oldRdict) projects['default'].rdict = JSON.parse(oldRdict);
            localStorage.removeItem('promptmask_dict');
            localStorage.removeItem('promptmask_rdict');
            saveAll();
        }
    } catch (e) { /* silent */ }
    if (!projects['default']) initProject('default');
    loadHistory();
    renderProjectSelect(); renderDict(); updateStats(0, 0, 0);
}

loadAll();
</script>
</body>
</html>
